#include <event2/event.h>#include <event2/bufferevent.h>#include <event2/buffer.h>#include <sys/socket.h>#include <sys/un.h>#include <netdb.h>#include <netinet/tcp.h>#include "cmdagent.h"#include "devcomm.h"static void devcom_prep(struct process_info *proc);static void devcom_run(struct process_info *proc);// void devcom_prep(struct process_info *proc){	struct tasks_cluster *tcluster = (struct tasks_cluster*)proc->root;	struct devcom_proc *dev_proc = (struct devcom_proc*)proc->priv;	struct task_info *dev_task = GET_TASK(tcluster, CMDAGENT_TASK_NAME_DEVICE);		ERRSYS_INFOPRINT("#### DEVCOM PREP #####\n");	devnet_connect(&dev_proc->dev_net) < 0);	dev_task->chgstat(dev_task, TASK_RUNNING);}void devcom_run(struct process_info *proc){	struct tasks_cluster *tcluster = (struct tasks_cluster*)proc->root;	struct devcom_proc *dev_proc = (struct devcom_proc*)proc->priv;	struct task_info *dev_task = GET_TASK(tcluster, CMDAGENT_TASK_NAME_DEVICE);	devnet_loop(&dev_proc->dev_net);	dev_task->chgstat(dev_task, TASK_QUIT);}// interface.int devcom_initialize(struct process_info *proc, int dev_idx){	int retval = -1;	struct tasks_cluster *tcluster = (struct tasks_cluster*)proc->root;	struct devcom_proc *devcom;	struct cmdagent_info agent_info;		if ((devcom = (struct devcom_proc*)zmalloc(sizeof(struct devcom_proc))) == NULL) {		ERRSYS_FATALPRINT("Fail to allocate devcom task\n");		goto err1;	}	proc->priv = devcom;	agent_info = (struct cmdagent_info *)tcluster->parent;	if( dev_idx < 0 || dev_idx > agent_info->dev_num){		goto err1;	}		devcom->dev_idx = dev_idx;	devcom->rack_index = agent_info->dev_info[dev_idx].rack_index;	strcpy(devcom->dev_net.ipaddr, agent_info->dev_info[dev_idx].ipaddr);	devcom->dev_net.usport = agent_info->dev_info[dev_idx].usport;				task_set_statmach(proc->parent, TASK_PREP, devcom_prep);	task_set_statmach(proc->parent, TASK_RUNNING, devcom_run);	ERRSYS_INFOPRINT("devcom process initialized.\n");	return 0;err1:	return retval;}void devcom_release(struct process_info *proc){	struct tasks_cluster *tcluster = (struct tasks_cluster*)proc->root;	struct devcom_proc *dev_proc = (struct devcom_proc*)proc->priv;	struct task_info *dev_task = GET_TASK(tcluster, CMDAGENT_TASK_NAME_DEVICE);	devnet_disconnect(&dev_proc->dev_net);	devnet_release(&dev_proc->dev_net);}